<h1>
  <%= @project.name %>
  <div class="pull-right">
    <%= link_to "Back", project_path(@project), class: "btn btn-default" %>
  </div>
</h1>

<h2><%= @deploy.summary %></h2>

<pre id="messages" class="pre-scrollable log">
  <% unless @deploy.active? %>
    <% @deploy.output.split("\n").each do |line| %>
<%= render_log(line) %>
    <% end %>
  <% end %>
</pre>

<% if @deploy.active? %>
  <%= javascript_tag do %>
    $(document).ready(function() {
      var messages = $("#messages");

      var source = new EventSource("<%= stream_deploy_path(@deploy.job) %>");
      source.addEventListener('message', function(e) {
        if(e.data !== "") {
          messages.append(JSON.parse(e.data).msg + '\n');
          messages.scrollTop(messages[0].scrollHeight);
        }
      }, false);

      source.addEventListener('open', function(e) {
        // Connection was opened.
      }, false);

      source.addEventListener('error', function(e) {
        // Connection was closed
      }, false);

      $("#deploy_stop").on("click", function() {
        $.ajax("<%= project_deploy_path(@project, @deploy) %>", {
          type: 'DELETE'
        });
        messages.addClass('failed');
        event.preventDefault();
      });
    });
  <% end %>

  <button id="deploy_stop" class="btn btn-danger pull-right">Stop</button>
<% else %>
  <div class="alert alert-<%= @deploy.failed?? "danger" : "success" %>">
    <%= @deploy.user.name %> deployed <%= @deploy.commit %> on <%= @deploy.stage.name %> at <%= @deploy.created_at %>
  </div>
<% end %>
