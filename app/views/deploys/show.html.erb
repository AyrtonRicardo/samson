<h1>
  <%= @project.name %>
  <div class="pull-right">
    <%= link_to "Back", project_path(@project), class: "btn btn-default" %>
  </div>
</h1>

<h2>
  <%= @deploy.summary %>
  <small><%= time_ago_in_words @deploy.created_at %> ago</small>
</h2>

<h4>Changes</h4>
<p>Commit range: <code><%= link_to @changeset.commit_range, @changeset.github_url %></code></p>

<table class="table">
  <tbody>
  <% @changeset.files.each do |file| %>
    <tr>
      <td><%= file_status_label file.status %> &nbsp; <%= file.filename %></td>
      <td align="right">
        <%= file_changes_label file.additions, "success" %>
        <%= file_changes_label file.changes, "info" %>
        <%= file_changes_label file.deletions, "danger" %>
      </td>
    </tr>
  <% end %>
  </tbody>
</table>

<h4>Commits</h4>
<table class="table">
  <tbody>
  <% @changeset.commits.each do |commit| %>
    <tr>
      <td><%= image_tag commit.author_avatar_url, width: 20, height: 20 %></td>
      <td><%= link_to commit.author_name, commit.author_url %></td>
      <td><%= link_to commit.message, commit.url %></td>
    </tr>
  <% end %>
  </tbody>
</table>

<h4>Output</h4>
<pre id="messages" class="pre-scrollable log">
  <% unless @deploy.active? %>
    <% @deploy.output.split("\n").each do |line| %>
<%= render_log(line) %>
    <% end %>
  <% end %>
</pre>

<% if !JobExecution.enabled %>
  <div class="alert alert-info">
    Pusher is currently restarting, your deploy has been queued and will be resumed shortly.
  </div>

  <%= javascript_tag do %>
    function check_enabled() {
      $.ajax({
        url: "<%= enabled_jobs_path %>",
        success: function(data, status, xhr) {
          if(xhr.status == 204) {
            window.location.reload()
          }
        }
      });

      setTimeout(check_enabled, 5000);
    }

    $(document).ready(function() {
      check_enabled();
    });
  <% end %>
<% elsif @deploy.active? %>
  <%= javascript_tag do %>
    $(document).ready(function() {
      var messages = $("#messages");

      var source = new EventSource("<%= stream_deploy_path(@deploy.job) %>");

      var addLine = function(data) {
        var msg = JSON.parse(data).msg;
        messages.append(msg);
        messages.scrollTop(messages[0].scrollHeight);
      }

      source.addEventListener('append', function(e) {
        addLine(e.data);
      }, false);

      source.addEventListener('replace', function(e) {
        messages.children().last().remove();
        addLine(e.data);
      }, false);

      source.addEventListener('finished', function(e) {
        window.location.reload();
      }, false);

      $("#deploy_stop").on("click", function() {
        $.ajax("<%= project_deploy_path(@project, @deploy) %>", {
          type: 'DELETE'
        });
        event.preventDefault();
      });
    });
  <% end %>

  <button id="deploy_stop" class="btn btn-danger pull-right">Stop</button>
<% else %>
  <div class="alert alert-<%= @deploy.succeeded?? "success" : "danger" %>">
    <%= @deploy.user.name %> deployed <%= @deploy.commit %> on <%= @deploy.stage.name %> at <%= @deploy.created_at %>
  </div>
<% end %>
