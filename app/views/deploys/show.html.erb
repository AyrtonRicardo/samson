<h1>
  <%= @project.name %>
  <div class="pull-right">
    <%= link_to "Back", project_path(@project), class: "btn btn-default" %>
  </div>
</h1>

<h2><%= @deploy.summary %></h2>

<pre id="messages" class="pre-scrollable log">
  <% unless @deploy.active? %>
    <% @deploy.output.split("\n").each do |line| %>
<%= render_log(line) %>
    <% end %>
  <% end %>
</pre>

<% if @deploy.active? %>
  <%= javascript_tag do %>
    $(document).ready(function() {
      var messages = $("#messages");

      var source = new EventSource("<%= stream_deploy_path(@deploy.job) %>");

      var addLine = function(data) {
        var msg = JSON.parse(data).msg;
        messages.append(msg);
        messages.scrollTop(messages[0].scrollHeight);
      }

      source.addEventListener('append', function(e) {
        addLine(e.data);
      }, false);

      source.addEventListener('replace', function(e) {
        messages.children().last().remove();
        addLine(e.data);
      }, false);

      source.addEventListener('finished', function(e) {
        window.location.reload();
      }, false);

      $("#deploy_stop").on("click", function() {
        $.ajax("<%= project_deploy_path(@project, @deploy) %>", {
          type: 'DELETE'
        });
        event.preventDefault();
      });
    });
  <% end %>

  <button id="deploy_stop" class="btn btn-danger pull-right">Stop</button>
<% else %>
  <div class="alert alert-<%= @deploy.succeeded?? "success" : "danger" %>">
    <%= @deploy.user.name %> deployed <%= @deploy.commit %> on <%= @deploy.stage.name %> at <%= @deploy.created_at %>
  </div>
<% end %>
