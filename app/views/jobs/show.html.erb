<h1>
  <%= project.name %>
  <div class="pull-right">
    <button class="btn btn-default">
      <%= link_to "Back", project_path(project) %>
    </button>
  </div>
</h1>

<pre id="messages" class="pre-scrollable log">
  <% job_history.log.split("\n").each do |log| %>
<%= render_log(log) %>
  <% end %>
</pre>

<% if (job_history.started? || job_history.running?) && job_history.user == current_user %>
  <%= form_for :job, url: url_for, method: :put, remote: true, html: { class: "form-inline" } do |form| %>
    <%= form.password_field :message, class: "form-control", autocomplete: "off" %>
    <div id="job_actions">
      <button class="btn btn-default">Submit</button>
      <button id="job_stop" class="btn btn-danger">Stop</button>
    </div>

    <small>
      <%= link_to "toggle input text", "#", id: "toggle-message-field", title: "Toggles the input field between password and text" %>
    </small>
  <% end %>

  <%= javascript_tag do %>
    $(document).ready(function() {
      var messages = $("#messages");

      var source = new EventSource("<%= stream_job_path(job_history) %>");
      source.addEventListener('message', function(e) {
        if(e.data !== "") {
          messages.append(JSON.parse(e.data).msg + '\n');
          messages.scrollTop(messages[0].scrollHeight);
        }
      }, false);

      source.addEventListener('open', function(e) {
        // Connection was opened.
      }, false);

      source.addEventListener('error', function(e) {
        console.log("error", e);
        //if (e.readyState == EventSource.CLOSED) {
          // Connection was closed.
        //}
      }, false);

      $("#toggle-message-field").click(function(event) {
        var input = $("#job_message");

        if(input.attr("type") == "password")
          input.attr("type", "text");
        else
          input.attr("type", "password");

        event.preventDefault();
      });

      $("form").on("ajax:complete", function() {
        $("#job_message").val("");
      });

      $("#job_stop").on("click", function() {
        $.ajax("<%= project_job_path(project, job_history) %>", {
          type: 'DELETE'
        });
        messages.addClass('failed');
        event.preventDefault();
      });
    });
  <% end %>
<% else %>
  <div class="alert alert-<%= job_history.failed?? "danger" : "success" %>">
    <%= job_history.user.name %> deployed <%= job_history.sha %> on <%= job_history.environment %> at <%= job_history.created_at %>
  </div>
<% end %>
